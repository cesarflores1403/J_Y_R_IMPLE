<!DOCTYPE html>
<html lang="es">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>JYR - Categor√≠as</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
<div class="app-layout"><div class="sidebar-overlay" id="sidebarOverlay"></div><aside class="sidebar" id="appSidebar"></aside>
<main class="main-content"><header class="top-header" id="appHeader"></header>
<div class="page-content fade-in">
    <div class="page-header"><div><h1>Categor√≠as</h1><p class="subtitle">Organizaci√≥n de productos</p></div>
    <button class="btn btn-primary" id="btnNew">+ Nueva Categor√≠a</button></div>
    <div class="toolbar">
        <div class="search-box">
            <span class="icon"><i class="fa fa-search"></i></span>
            <input type="text" placeholder="Buscar categor√≠a..." id="searchInput">
        </div>
    </div>
    <div class="card">
        <div class="table-container"><table><thead><tr><th>Nombre</th><th>Descripci√≥n</th><th>Productos</th><th>Acciones</th></tr></thead>
    <tbody id="tableBody"><tr><td colspan="4"><div class="spinner"></div></td></tr></tbody></table></div></div>
</div></main></div>

<div class="modal-overlay" id="catModal"><div class="modal" style="max-width:460px"><div class="modal-header"><h2 id="modalTitle">Nueva Categor√≠a</h2><button class="modal-close" onclick="document.getElementById('catModal').classList.remove('active')">√ó</button></div>
<div class="modal-body"><form id="catForm"><input type="hidden" id="catId">
<div class="form-group"><label class="form-label">Nombre *</label><input class="form-control" id="catName" required></div>
<div class="form-group"><label class="form-label">Descripci√≥n</label><textarea class="form-control" id="catDesc" rows="2"></textarea></div></form></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('catModal').classList.remove('active')">Cancelar</button><button class="btn btn-primary" id="btnSave">Guardar</button></div></div></div>

<script type="module">
    import { initShell } from '../js/modules/shell.js'; import api from '../js/utils/api.js'; import toast from '../js/utils/toast.js'; import modal from '../js/utils/modal.js';
    initShell('categories');

    async function load(){const tb=document.getElementById('tableBody');tb.innerHTML='<tr><td colspan="4"><div class="spinner"></div></td></tr>';
        try{const r=await api.get('/categories');
        let data=r.data;const q=(document.getElementById('searchInput').value||'').toLowerCase();
        if(q)data=data.filter(c=>c.name.toLowerCase().includes(q));
        if(!data.length){tb.innerHTML='<tr><td colspan="4"><div class="empty-state"><h3>Sin categor√≠as</h3></div></td></tr>';return;}
        tb.innerHTML=data.map(c=>
        `<tr><td><strong>${c.name}</strong></td><td>${c.description||'-'}</td><td>${c.productCount||0}</td>
        <td><div class="btn-group"><button class="btn btn-ghost btn-sm" onclick="editCat(${c.id})">‚úèÔ∏è</button><button class="btn btn-ghost btn-sm" onclick="delCat(${c.id},'${c.name}')">üóëÔ∏è</button></div></td></tr>`).join('');}catch(e){}}

    document.getElementById('btnNew').addEventListener('click',()=>{document.getElementById('catForm').reset();document.getElementById('catId').value='';document.getElementById('modalTitle').textContent='Nueva Categor√≠a';modal.open('catModal');});
    document.getElementById('btnSave').addEventListener('click',async()=>{const f=document.getElementById('catForm');if(!f.checkValidity()){f.reportValidity();return;}
        const id=document.getElementById('catId').value;const body={name:document.getElementById('catName').value.trim(),description:document.getElementById('catDesc').value.trim()||null};
        try{const r=id?await api.put(`/categories/${id}`,body):await api.post('/categories',body);if(r?.success){toast.success(id?'Actualizada':'Creada');modal.close('catModal');load();}else toast.error(r?.message);}catch(e){toast.error(e.message);}});

    window.editCat=async(id)=>{try{const r=await api.get(`/categories/${id}`);if(!r?.success)return;document.getElementById('modalTitle').textContent='Editar';document.getElementById('catId').value=r.data.id;document.getElementById('catName').value=r.data.name;document.getElementById('catDesc').value=r.data.description||'';modal.open('catModal');}catch(e){}};
    window.delCat=async(id,n)=>{if(!await modal.confirm(`¬øEliminar "${n}"?`))return;try{await api.delete(`/categories/${id}`);toast.success('Eliminada');load();}catch(e){toast.error(e.message);}};
     document.getElementById('searchInput').addEventListener('input',function(){clearTimeout(this._t);this._t=setTimeout(load,300);});
    load();
    load();
</script>
</body></html>
